# Источники

1. https://reference.aspose.com/3d/python-net/ - коммерческое решение с каким-то совершенно [неадекватным ценником](https://purchase.aspose.com/pricing/). Есть python-пакет [в публичном доступе](https://pypi.org/project/aspose-3d/), но исходников в нем нет, только схематично объявлены классы, остальное - в уже компилированных файлах. Требует версию Python<3.12. Фактически не работает без лицензионного ключа. Пробный функционал недоступен, вызывается исключение:

```bash
RuntimeError: Proxy error(TrialException): You're using Aspose.3D without a valid license, please apply a trial license or turn the exception off by setting TrialException.SuppressTrialException to true, check https://docs.aspose.com/3d/net/licensing/ for more details.
```

При этом изменение свойства класса TrialException фактически запрещено, поскольку это файл зависимости, а создание аналогичного класса ни к чему не приводит - он никак не связан с компонентами библиотеки. [Репозиторий](https://github.com/aspose-3d/Aspose.3D-for-Python-via-.NET) - просто рекламная витрина, исходников нет.

2. https://github.com/smth-for/gltf-to-usdz - собранный из отдельных компонентов Docker-образ. Фактически основан на полуофициальном конвертере [из репозитория Google](https://github.com/google/usd_from_gltf), который использует SDK [USD](https://github.com/PixarAnimationStudios/USD) не самой актуальной ~20 версии. **Которая билдится из исходников с помощью Python2.7**, причем просто перейти на Python3 нельзя, там используется специфический для Python2 синтаксис. Поначалу это не было проблемой, билд Docker-образа происходил нормально.

А вот завершить с использованием данного готового образа, как это делали авторы цитируемого репозитория, установку конвертера от Google так и не удалось, ошибка связана с неправильными/некорректными/неактуальными исходниками 3D-компрессора [Draco](https://github.com/google/draco):

```bash
108.7 /usr/local/ufg/src/draco-1.3.5/src/draco/core/hash_utils.h:57:3: note: ‘size_t’ is defined in header ‘<cstddef>’; did you forget to ‘#include <cstddef>’?
108.7 gmake[2]: *** [CMakeFiles/draco_core.dir/build.make:188: CMakeFiles/draco_core.dir/src/draco/core/hash_utils.cc.o] Error 1
108.7 gmake[1]: *** [CMakeFiles/Makefile2:563: CMakeFiles/draco_core.dir/all] Error 2
108.7 gmake: *** [Makefile:136: all] Error 2
108.7 
108.7   DRACO: ERROR: Command failed: cmake --build . --config Release --target install --
108.7   DRACO: See log at: /usr/local/ufg/build/draco-1.3.5/log.txt
```

Возможно, это связано с особенностями компиляции различных версий, но проверка потребовала бы слишком много времени без гарантий какого-либо адекватного результата. Поэтому принято решение перейти к следующему варианту.

3. https://github.com/Plattar/python-usd-ar - конвертер из GLB в USDZ[^1]. Несмотря на [заявленную](https://github.com/Plattar/python-usd-ar/blob/main/usdzconvert/help.txt) поддержку форматов `OBJ/glTF(.gltf/glb)/FBX/Alembic(.abc)/USD(.usd/usda/usdc/usdz)`, фактически работает только конвертация из GLB в USDZ. GLTF сам по себе, как файл с контентом JSON-формата не поддерживается, требуется бинарный компонент. Для конвертации FBX требует [соответствующий SDK](https://aps.autodesk.com/developer/overview/fbx-sdk), однако нативной версии этого SDK для Python3.9, который используется в Docker-образе из репозитория, нет, есть только для 3.7 в виде файлов *.so (обратно не совместимы, при импорте вызывает `Segmentation Fault` у CPython) и для 3.10 в формате whl (который не билдится на Python3.9). Даунгрейд до 3.7 нецелесообразен, так как потребует переписывания кода сервера (FastAPI работает на Python начиная с версии 3.8) и не гарантирует работоспособности в итоге. Апгрейд образа до Python3.10 тоже не гарантирует, что образ конвертера в принципе соберется без ошибок.

Энтузиаст [самостоятельно собрал SDK](https://forums.autodesk.com/t5/fbx-forum/fbx-python-sdk-for-python-3-9/td-p/11459327) для версии Python3.9, но потом зачем-то скомпилировал его в *.pyd-файлы - фактически dll-библиотеки Windows. Если понадобится локально на компьютере под управлением ОС Windows запустить этот SDK на Python3.9, то все готово, но для веб-сервера, который будет разворачиваться на каком-нибудь VDS под Linux эти файлы абсолютно бесполезны, а декомпилировать их не удалось.

Образы из [репозитория Docker](https://hub.docker.com/r/plattar/python-usd-ar) через один не собираются либо работают на еще более старых версиях Python.

За основу взята именно версия из репозитория GitHub, от греха подальше, чтобы автор случайно не изменил чего-то и все сломалось, все исходники включены в репозиторий данного проекта.

4. https://github.com/kcoley/gltf2usd/ - заявлено, как решение, работающее для [USD](https://github.com/PixarAnimationStudios/USD) версий 18.09 или 18.11. А эти версии собираются на Python2.7, переход на Python3 и стыковка раритета с сервером потребовала бы слишком много времени, к тому же, неясно, какой формат GLTF поддерживается - JSON или тоже с бинарным компонентом.

5. https://github.com/marlon360/gltf-to-usdz-service/ - вполне работающее решение. Из минусов - не конвертирует FBX-файлы, только GLB. GLTF не тестировались. Потенциально можно развернуть в соседнем контейнере с сервером и посредством общего именованного тома обмениваться файлами: получил файл от пользователя, положил в общий том, отправил по HTTP запрос, файл локально в общем томе конвертируется, возвращает ответ со статусом 200, после чего можно забрать результат из общего тома и вернуть пользователю.

6. https://github.com/facebookincubator/FBX2glTF - конвертер из FBX в GLTF/GLB (по-дефолту возвращает файл GLTF, но с флагом `-b` - уже бинарный GLB). Готовый скомпилированный файл, работает локально, весит мало, вопросов не задает. В проекте используется именно как промежуточный конвертер из FBX в GLB, а дальше подключается решение из пункта 3. Возможно, неоптимально, но сам конвертер работает быстро и, самое главное, **работает**, поэтому без него в отсутствие нормального человеческого FBX Python SDK не обошлось.

7. https://pypi.org/project/pygltflib/ - Python-пакет, из всего функционала которого получилось оценить только конвертацию бинарного GLB в JSON-компонент GLTF. Обратная конвертация, к сожалению, бинарный компонент не добавляет.

8. https://pypi.org/project/py-fbx/ - Python-пакет для работы с FBX-файлами, но в проекте не пригодился, поскольку работа происходит не на уровне файлов и ОС в контейнере, а внутри python-кода, поэтому оценить не представилось возможным.

Результат тестировался онлайн на https://www.usdz-viewer.net/. Модель рендерится прямо на клиенте за счет достаточно легковесного [npm-пакета](https://www.npmjs.com/package/three-usdz-loader).

[^1]: Начиная с этого этапа новые ветки не создавались, поскольку в условиях дефицита свободного времени все неподходящие варианты стали просто отбрасываться.