#ar_converter

## Онлайн-конвертер AR-файлов

## Поддерживамые форматы:

- GLB
- FBX

## Подготовка к запуску

Перед запуском приложения необходимо создать конфигурацию приложения - файл `.env` в корневой директории проекта - и наполнить его переменными окружения по образцу файла [`.env.example`](./env.example). Можно просто переименовать файл [`.env.example`](./env.example) в `.env`, если никакие настройки менять не собираетесь.

Значения настроек:

- `APP__MOUNT_SWAGGER` - необходима ли автогенерация интерактивной документации [Swagger](https://thecode.media/chto-takoe-swagger-i-kak-on-oblegchaet-rabotu-s-api/). Допустимые значения: `True/False`[^1]. Если `True`, после запуска приложения по адресу [/docs](localhost:9191/docs) будет доступа схема API;
- `APP__MOUNT_REDOC` - необходима ли автогенерация интерактивной документации [Redoc](https://aappss.ru/b/rest-api/?ysclid=m4lpmbx55332788192). Допустимые значения: `True/False`[^1]. Если `True`, после запуска приложения по адресу [/redoc](localhost:9191/redoc) будет доступа схема API;

- `UVICORN__HOST` - хост, с которым связан сокет, который слушает веб-сервер. Поскольку запуск веб-приложения предполагается в Docker-контейнере, это значение лучше оставить "0.0.0.0";
- `UVICORN__PORT` - порт внутри контейнера, который слушает веб-сервер. Можно указывать любое число, обычно принято указывать четырехзначное. Настройка выведена в переменную окружения на случай, если в будущем в контейнере будет запускаться еще какое-то веб-приложение (нежелательно, но тем не менее). Тогда понадобится "разводить" порты, чтобы не было пересечений, иначе может возникнуть ошибка;
- `UVICORN__WORKERS` - веб-приложение работает асинхронно, это значит, что оно способно обрабатывать несколько параллельных запросов. Эта настройка отвечает за то, сколько процессов сервера будет запущено одновременно для обработки входящих запросов. Рекомендуемое количество - *2 x количество ядер процессора +1*;

- `CONTAINER__EXTERNAL_PORT` - порт хоста, на который будут поступать запросы, которые необходимо передать внутрь контейнера для работы веб-приложения. Пример: если адрес сервера, на котором развернуто приложение, 81.18.244.92, а значение `CONTAINER__EXTERNAL_PORT` указано 9000, то HTTP-запросы необходимо посылать по адресу http://81.18.244.92:9000. Они будут получены сервером-компьютером и переданы веб-приложению, которое вернет на них соответствующие ответы. В качестве значения можно так же, как и в случае `UVICORN__PORT`, указывать любое число, главное, чтобы оно не совпадало с портами, которые слушают другие приложения этого хоста. Стандартный порт для HTTP-запросов - 80, для HTTPS-запросов - 443.
 
## Запуск

 Существует два варианта запуска приложения:

1) Запустить скрипт `launch.sh`;
2) В терминале/командной строке, находясь в директории проекта, запустить команду

```bash
    docker compose up
```

Первый вариант является более предпочтительным для одиночного запуска приложения в качестве бэкенд-API (если планируется его использование в контексте каких-либо других программ).

При запуске API собираются два Docker-образа: ядро работы с файлами и непосредственно веб-сервер, на основе последнего образа запускается контейнер с веб-приложением.[^2]

Поскольку `docker compose` все же больше про запуск контейнеров, чем про сборку образа как итоговый результат, запуск приложения с помощью этой утилиты не совсем "конвенционален" и предусмотрен на случай, если поверх бэкенда будет установлен фронтенд-компонент, который можно будет удобно встроить в собственном контейнере для организации сети контейнеров.

## Использование[^3]

После запуска приложения, веб-сервер готов принимать запросы. Если сервер запущен локально на компьютере, запросы принимаются по адресу [localhost:9191/convertion/](localhost:9191/convertion/).

Обязательным заголовком HTTP-запроса является `X-Extension`. Поскольку конвертер в настоящий момент способен обрабатывать файлы формата *.GLB* и *.FBX*, то допустимые варианты значений данного заголовка - `glb` и `fbx`, строчными буквами, без точек.

В теле HTTP-запроса ожидается параметр `file`, значением которого является непосредственно файл, который необходимо сконвертировать (его бинарный контент).

При поступлении запроса на сервер происходит его валидация: проверяются наличие заголовка `X-Extension`, наличие тела запроса, наличие в теле запроса параметра `file`, наличие у данного параметра значения (самого файла), расширение файла и его соответствие значению заголовка `X-Extension`. 

Если хотя бы одна проверка не будет пройдена, сервер вернет ошибку. Файлы без расширения приложением не конвертируются, поскольку не гарантируется целостность данных в итоговом файле.

Если валидация прошла успешно, файл конвертируется и возвращается в теле ответа. Название файла не изменяется, за исключением расширения: 

> File.glb/File.fbx -> File.usdz

Как уже упоминалось, если в файле `.env` значение `APP__MOUNT_SWAGGER` установлено как `True`, то дополнительно по адресу [localhost:9191/docs/](localhost:9191/docs/) доступна схема API. 

Аналогично, если значение `True` установлено параметру `APP__MOUNT_REDOC` - схема доступна по адресу [localhost:9191/redoc/](localhost:9191/redoc/).

Обе схемы могут быть "включены" в настройках одновременно, друг с другом они не конфликтуют. 

Если "включена" хотя бы одна из них, схему API можно скачать по адресу [localhost:9191/openapi.json](localhost:9191/openapi.json).


[^1]: Написание имеет значение, `true/false` строчными буквами вызовет ошибку.
[^2]: Многоступенчатая сборка в данном случае может быть рассмотрена на перспективное развитие, однако в данный момент ядро конвертера является вполне самостоятельным компонентом и может быть использовано для других веб-приложений.
[^3]: Все примеры приводятся для настроек, указанных на момент написания документации в файле [`.env.example`](./env.example).